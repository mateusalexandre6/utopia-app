<dialog class="modal modal-open">
  <div class="modal-box bg-gray-800 text-gray-100 w-11/12 max-w-3xl border border-gray-700 shadow-2xl">

    <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
      <div>
        <h3 class="font-bold text-xl text-white">Gerenciar Permissões</h3>
        <p class="text-sm text-gray-400 mt-1">Usuário: <span class="text-primary font-medium">{{ user.displayName || user.email }}</span></p>
      </div>
      <button (click)="close.emit()" class="btn btn-sm btn-circle btn-ghost text-gray-400 hover:text-white">✕</button>
    </div>

    <div class="space-y-8 max-h-[60vh] overflow-y-auto pr-2">

      @if (isNationalAdminInput) {
        <div class="bg-gray-700/30 p-4 rounded-lg border border-gray-600/50">
          <h4 class="text-sm font-bold text-gray-300 uppercase tracking-wide mb-3 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-yellow-500">
              <path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clip-rule="evenodd" />
            </svg>
            Nacional
          </h4>
          <div class="form-control">
            <label class="label cursor-pointer justify-start gap-3 hover:bg-gray-700 p-2 rounded-md transition-colors">
              <input type="checkbox"
                     class="checkbox checkbox-warning"
                     [checked]="isNationalAdminTarget()"
                     (change)="toggleNationalAdmin($any($event.target).checked)" />
              <span class="label-text text-gray-100 font-medium">Administrador Nacional (Acesso Total)</span>
            </label>
          </div>
        </div>
      }

      <div>
        <h4 class="text-sm font-bold text-gray-300 uppercase tracking-wide mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-primary">
            <path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.1.4-.22.655-.364C11.888 18.005 13 16.908 13 15.5c0-1.293-.82-2.528-2-3.414-.142-.107-.26-.184-.345-.245a.75.75 0 00-.81 0c-.086.06-.203.138-.345.245-1.18.886-2 2.121-2 3.414 0 1.408 1.112 2.505 1.769 3.082.256.144.47.264.655.364a5.741 5.741 0 00.28.14l.018.008.006.003zM10 11.25a2.25 2.25 0 100 4.5 2.25 2.25 0 000-4.5z" clip-rule="evenodd" />
          </svg>
          Núcleos e Organizações
        </h4>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          @for (org of visibleOrganizations(); track org.id) {
            <div class="card bg-gray-700/30 border border-gray-600 shadow-sm hover:border-gray-500 transition-colors">
              <div class="card-body p-4">
                <h5 class="card-title text-base text-gray-200 border-b border-gray-600/50 pb-2 mb-2">
                  {{ org.name }}
                </h5>

                <div class="space-y-1">
                  @for (role of availableRoles; track role.value) {
                    <div class="form-control">
                      <label class="label cursor-pointer justify-start gap-3 py-1 hover:bg-gray-600/30 rounded px-2 -mx-2">
                        <input type="checkbox"
                               class="checkbox checkbox-xs checkbox-primary rounded-sm"
                               [checked]="hasRoleInOrg(org.id, role.value)"
                               (change)="toggleRole(org.id, role.value, $any($event.target).checked)" />
                        <span class="label-text text-sm"
                              [class.text-white]="hasRoleInOrg(org.id, role.value)"
                              [class.text-gray-400]="!hasRoleInOrg(org.id, role.value)">
                          {{ role.label }}
                        </span>
                      </label>
                    </div>
                  }
                </div>
              </div>
            </div>
          }

          @if (visibleOrganizations().length === 0) {
            <div class="col-span-2 alert alert-warning bg-yellow-900/20 text-yellow-200 border-yellow-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
              <div>
                <h3 class="font-bold">Nenhum núcleo encontrado!</h3>
                <p class="text-xs">Você não gerencia nenhum núcleo ou não tem permissão.</p>

                <div class="mt-2 p-2 bg-black/50 rounded text-xs font-mono text-gray-300">
                  <p><strong>Meus IDs (Input):</strong> {{ debugData().myIds | json }}</p>
                  <p><strong>Total de Núcleos no Banco:</strong> {{ debugData().totalOrgs }}</p>
                  <p><strong>IDs de Núcleos no Banco:</strong> {{ debugData().allOrgIds | json }}</p>
                </div>
              </div>
            </div>
          }
        </div>
      </div>

    </div>

    <div class="modal-action border-t border-gray-700 pt-4 mt-6">
      <button (click)="close.emit()" class="btn btn-ghost hover:bg-gray-700 text-gray-300">Cancelar</button>
      <button (click)="onSave()" class="btn btn-primary text-white" [disabled]="isLoading()">
        @if (isLoading()) { <span class="loading loading-spinner loading-xs"></span> }
        Salvar Alterações
      </button>
    </div>
  </div>

  <form method="dialog" class="modal-backdrop bg-black/80" (click)="close.emit()">
    <button>close</button>
  </form>
</dialog>
