<div class="space-y-6 text-gray-100 p-4">
  <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
    <h1 class="text-2xl font-bold text-gray-100">Quadro de Atividades</h1>

     <div class="join">
      <button
        class="btn btn-sm join-item"
        [class.btn-primary]="filterState() === 'my-organizations'"
        (click)="setFilterState('my-organizations')"
        [disabled]="isNationalAdmin()">
        Minhas ComissÃµes
      </button>
      <button
        class="btn btn-sm join-item"
        [class.btn-primary]="filterState() === 'all'"
        (click)="setFilterState('all')">
        Todas
      </button>
    </div>

    <button
      (click)="onNewTask()"
      class="btn btn-primary flex items-center gap-2 px-4 py-2 rounded-lg transition-all duration-300 hover:scale-[1.03] active:scale-[0.97]"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
        <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
      </svg>
      Nova Tarefa
    </button>
  </div>

  <div class="flex flex-wrap gap-4 bg-gray-800/50 p-3 rounded-lg border border-gray-700 items-center">
    <span class="text-sm font-semibold text-gray-400 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
      Filtrar por:
    </span>

    @if (filterState() === 'all') {
      <select
        [ngModel]="selectedOrgFilter()"
        (ngModelChange)="selectedOrgFilter.set($event); selectedCommissionFilter.set('')"
        class="select select-bordered select-sm bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:border-primary">
        <option value="">Todos os NÃºcleos</option>
        @for (org of allOrganizations(); track org.id) {
          <option [value]="org.id">{{ org.name }}</option>
        }
      </select>
    }

    <select
      [ngModel]="selectedCommissionFilter()"
      (ngModelChange)="selectedCommissionFilter.set($event)"
      [disabled]="filterState() === 'all' && !selectedOrgFilter()"
      class="select select-bordered select-sm bg-gray-700 text-gray-100 border-gray-600 focus:outline-none focus:border-primary disabled:bg-gray-800 disabled:text-gray-500">
      <option value="">Todas as ComissÃµes</option>
      @for (comm of commissionsForFilter(); track comm.id) {
        <option [value]="comm.id">{{ comm.name }}</option>
      }
    </select>

    @if (selectedOrgFilter() || selectedCommissionFilter()) {
      <button
        (click)="selectedOrgFilter.set(''); selectedCommissionFilter.set('')"
        class="btn btn-ghost btn-xs text-gray-400 hover:text-white">
        Limpar Filtros âœ•
      </button>
    }
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full min-h-[500px]" cdkDropListGroup>

    <div class="flex flex-col bg-gray-800 rounded-xl p-4 shadow-lg border border-gray-700">
      <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-indigo-400">
        <div class="w-3 h-3 rounded-full bg-indigo-500"></div>
        A Fazer <span class="text-sm font-normal text-gray-500 ml-auto">{{ todoTasks().length }}</span>
      </h2>

      <div
        cdkDropList
        id="todo"
        [cdkDropListData]="todoTasks()"
        (cdkDropListDropped)="onTaskDrop($event)"
        class="flex-1 flex flex-col gap-3 min-h-[100px]"
      >
        @for (task of todoTasks(); track task.id) {
          <div
            class="card bg-gray-700 hover:bg-gray-650 transition-all relative rounded-lg border border-gray-600 group"
            cdkDrag
            [cdkDragData]="task"
          >
            <div class="card-body p-4">
              <div class="flex justify-between items-start mb-2">
                <span class="badge badge-xs font-semibold border-none"
                  [ngClass]="{
                    'badge-error text-white': task.priority === 'high',
                    'badge-warning text-black': task.priority === 'medium',
                    'badge-success text-white': task.priority === 'low'
                  }">
                  {{ task.priority === 'high' ? 'Alta' : task.priority === 'medium' ? 'MÃ©dia' : 'Baixa' }}
                </span>

                @if (canModify(task)) {
                  <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button (click)="onEditTask(task)" class="btn btn-ghost btn-xs text-gray-400 hover:text-white px-1">âœŽ</button>
                    <button (click)="onDeleteTask(task)" class="btn btn-ghost btn-xs text-red-400 hover:text-red-200 px-1">ðŸ—‘</button>
                  </div>
                }
              </div>

              <h3 class="font-semibold text-gray-100 leading-snug">{{ task.title }}</h3>

              @if (task.description) {
                <p class="text-xs text-gray-400 mt-2 line-clamp-2">{{ task.description }}</p>
              }

              <div class="flex justify-between items-end mt-3 pt-3 border-t border-gray-600/50">
                <span class="badge badge-ghost badge-sm h-auto py-1 text-left whitespace-normal text-indigo-200 bg-indigo-900/30 border-indigo-500/30">
                  {{ task.commissionName }}
                </span>

                @if (task.assignedToName) {
                  <div class="tooltip tooltip-left" [attr.data-tip]="task.assignedToName">
                    <div class="avatar placeholder">
                      <div class="bg-indigo-600 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center ring-2 ring-gray-700">
                        <span>{{ task.assignedToName.charAt(0).toUpperCase() }}</span>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>

    <div class="flex flex-col bg-gray-800 rounded-xl p-4 shadow-lg border border-gray-700">
      <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-yellow-400">
        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
        Fazendo <span class="text-sm font-normal text-gray-500 ml-auto">{{ doingTasks().length }}</span>
      </h2>

      <div
        cdkDropList
        id="doing"
        [cdkDropListData]="doingTasks()"
        (cdkDropListDropped)="onTaskDrop($event)"
        class="flex-1 flex flex-col gap-3 min-h-[100px]"
      >
        @for (task of doingTasks(); track task.id) {
           <div class="card bg-gray-700 hover:bg-gray-650 transition-all relative rounded-lg border border-gray-600 group" cdkDrag [cdkDragData]="task">
            <div class="card-body p-4">
              <div class="flex justify-between items-start mb-2">
                <span class="badge badge-xs font-semibold border-none" [ngClass]="{'badge-error text-white': task.priority === 'high', 'badge-warning text-black': task.priority === 'medium', 'badge-success text-white': task.priority === 'low'}">
                  {{ task.priority === 'high' ? 'Alta' : task.priority === 'medium' ? 'MÃ©dia' : 'Baixa' }}
                </span>
                @if (canModify(task)) {
                  <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button (click)="onEditTask(task)" class="btn btn-ghost btn-xs text-gray-400 hover:text-white px-1">âœŽ</button>
                    <button (click)="onDeleteTask(task)" class="btn btn-ghost btn-xs text-red-400 hover:text-red-200 px-1">ðŸ—‘</button>
                  </div>
                }
              </div>
              <h3 class="font-semibold text-gray-100 leading-snug">{{ task.title }}</h3>
              <div class="flex justify-between items-end mt-3 pt-3 border-t border-gray-600/50">
                <span class="badge badge-ghost badge-sm h-auto py-1 text-left whitespace-normal text-yellow-200 bg-yellow-900/30 border-yellow-500/30">
                  {{ task.commissionName }}
                </span>
                @if (task.assignedToName) {
                  <div class="tooltip tooltip-left" [attr.data-tip]="task.assignedToName">
                    <div class="avatar placeholder"><div class="bg-indigo-600 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center ring-2 ring-gray-700"><span>{{ task.assignedToName.charAt(0).toUpperCase() }}</span></div></div>
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>

    <div class="flex flex-col bg-gray-800 rounded-xl p-4 shadow-lg border border-gray-700">
      <h2 class="font-bold text-lg mb-4 flex items-center gap-2 text-green-400">
        <div class="w-3 h-3 rounded-full bg-green-500"></div>
        ConcluÃ­do <span class="text-sm font-normal text-gray-500 ml-auto">{{ doneTasks().length }}</span>
      </h2>

      <div
        cdkDropList
        id="done"
        [cdkDropListData]="doneTasks()"
        (cdkDropListDropped)="onTaskDrop($event)"
        class="flex-1 flex flex-col gap-3 min-h-[100px]"
      >
        @for (task of doneTasks(); track task.id) {
           <div class="card bg-gray-700 hover:bg-gray-650 transition-all relative rounded-lg border border-gray-600 group opacity-75 hover:opacity-100" cdkDrag [cdkDragData]="task">
            <div class="card-body p-4">
              <div class="flex justify-between items-start mb-2">
                <span class="badge badge-xs font-semibold border-none" [ngClass]="{'badge-error text-white': task.priority === 'high', 'badge-warning text-black': task.priority === 'medium', 'badge-success text-white': task.priority === 'low'}">
                  {{ task.priority === 'high' ? 'Alta' : task.priority === 'medium' ? 'MÃ©dia' : 'Baixa' }}
                </span>
                @if (canModify(task)) {
                  <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button (click)="onEditTask(task)" class="btn btn-ghost btn-xs text-gray-400 hover:text-white px-1">âœŽ</button>
                    <button (click)="onDeleteTask(task)" class="btn btn-ghost btn-xs text-red-400 hover:text-red-200 px-1">ðŸ—‘</button>
                  </div>
                }
              </div>
              <h3 class="font-semibold text-gray-100 leading-snug line-through decoration-gray-500">{{ task.title }}</h3>
              <div class="flex justify-between items-end mt-3 pt-3 border-t border-gray-600/50">
                <span class="badge badge-ghost badge-sm h-auto py-1 text-left whitespace-normal text-green-200 bg-green-900/30 border-green-500/30">
                  {{ task.commissionName }}
                </span>
                @if (task.assignedToName) {
                  <div class="tooltip tooltip-left" [attr.data-tip]="task.assignedToName">
                    <div class="avatar placeholder"><div class="bg-indigo-600 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center ring-2 ring-gray-700"><span>{{ task.assignedToName.charAt(0).toUpperCase() }}</span></div></div>
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  </div>

  @if (isFormVisible()) {
    <app-task-form
      [taskToEdit]="editingTask() || undefined"
      (close)="onCloseForm()"
    />
  }

  @if (taskToDelete()) {
    <dialog class="modal modal-open">
      <div class="modal-box bg-gray-800 text-gray-100">
        <h3 class="font-bold text-lg text-red-400">Excluir Tarefa</h3>
        <p class="py-4">
          Tem certeza que deseja excluir a tarefa <span class="font-bold text-white">"{{ taskToDelete()?.title }}"</span>?
          <br>
          <span class="text-sm text-gray-400">Esta aÃ§Ã£o nÃ£o pode ser desfeita.</span>
        </p>
        <div class="modal-action">
          <button class="btn btn-ghost text-gray-300" (click)="cancelDelete()">Cancelar</button>
          <button class="btn btn-error text-white" (click)="confirmDelete()">Sim, Excluir</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop" (click)="cancelDelete()">
        <button>close</button>
      </form>
    </dialog>
  }
</div>
